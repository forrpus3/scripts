local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local lp = Players.LocalPlayer
local ws = workspace

for _, v in ipairs(workspace:GetDescendants()) do
    if v.ClassName == "ProximityPrompt" then
        v.HoldDuration = 0
        v.MaxActivationDistance = 50
    end
end
workspace.DescendantAdded:Connect(function(v)
    if v.ClassName == "ProximityPrompt" then
        v.HoldDuration = 0
        v.MaxActivationDistance = 50
    end
end)

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFarmGUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = lp:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 180, 0, 140)
mainFrame.Position = UDim2.new(0, 20, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 15)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Color = Color3.fromRGB(80, 80, 90)
mainStroke.Thickness = 2
mainStroke.Parent = mainFrame

local dragHandle = Instance.new("Frame")
dragHandle.Name = "DragHandle"
dragHandle.Size = UDim2.new(1, 0, 0, 30)
dragHandle.Position = UDim2.new(0, 0, 0, 0)
dragHandle.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
dragHandle.BorderSizePixel = 0
dragHandle.Parent = mainFrame

local dragCorner = Instance.new("UICorner")
dragCorner.CornerRadius = UDim.new(0, 15)
dragCorner.Parent = dragHandle

local dragLabel = Instance.new("TextLabel")
dragLabel.Size = UDim2.new(1, 0, 1, 0)
dragLabel.BackgroundTransparency = 1
dragLabel.Text = "ðŸ”„ DRAG ME"
dragLabel.TextColor3 = Color3.fromRGB(150, 150, 160)
dragLabel.TextSize = 12
dragLabel.Font = Enum.Font.GothamBold
dragLabel.Parent = dragHandle

local statusFrame = Instance.new("Frame")
statusFrame.Name = "StatusFrame"
statusFrame.Size = UDim2.new(1, -20, 0, 25)
statusFrame.Position = UDim2.new(0, 10, 0, 40)
statusFrame.BackgroundTransparency = 1
statusFrame.Parent = mainFrame

local statusDot = Instance.new("Frame")
statusDot.Name = "StatusDot"
statusDot.Size = UDim2.new(0, 8, 0, 8)
statusDot.Position = UDim2.new(0, 30, 0.5, -4)
statusDot.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
statusDot.BorderSizePixel = 0
statusDot.Parent = statusFrame

local dotCorner = Instance.new("UICorner")
dotCorner.CornerRadius = UDim.new(1, 0)
dotCorner.Parent = statusDot

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -50, 1, 0)
statusLabel.Position = UDim2.new(0, 45, 0, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "INACTIVE"
statusLabel.TextColor3 = Color3.fromRGB(120, 120, 130)
statusLabel.TextSize = 14
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = statusFrame

local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = UDim2.new(1, -20, 0, 45)
toggleButton.Position = UDim2.new(0, 10, 0, 75)
toggleButton.BackgroundColor3 = Color3.fromRGB(40, 180, 70)
toggleButton.BorderSizePixel = 0
toggleButton.Text = "âš¡ START FARM"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextSize = 16
toggleButton.Font = Enum.Font.GothamBold
toggleButton.AutoButtonColor = false
toggleButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 10)
buttonCorner.Parent = toggleButton

local farmEnabled = false
local farmThread = nil
local beachChairPositions = {}

local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    local newPos = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
    TweenService:Create(mainFrame, TweenInfo.new(0.1), {Position = newPos}):Play()
end

dragHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        update(input)
    end
end)

local noclipEnabled = false
local noclipConnection = nil
local cam = workspace.CurrentCamera
local originalCamMode = nil

local function enableNoclip()
    if noclipConnection then return end
    noclipEnabled = true
    
    originalCamMode = cam.CameraType
    
    local player = lp
    if player then
        player.CameraMode = Enum.CameraMode.Classic
        player.CameraMaxZoomDistance = 128
        player.CameraMinZoomDistance = 0.5
    end
    
    pcall(function()
        lp.DevCameraOcclusionMode = Enum.DevCameraOcclusionMode.Invisicam
    end)
    
    noclipConnection = RunService.Stepped:Connect(function()
        if not noclipEnabled then return end
        
        local char = lp.Character
        if not char then return end
        
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end)
end

local function disableNoclip()
    noclipEnabled = false
    
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    pcall(function()
        lp.DevCameraOcclusionMode = Enum.DevCameraOcclusionMode.Zoom
    end)
    
    if originalCamMode then
        cam.CameraType = originalCamMode
    end
    
    local char = lp.Character
    if char then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.CanCollide = true
            end
        end
    end
end

local function cacheBeachChairs()
    beachChairPositions = {}
    for _, obj in ipairs(ws:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == "Beach chair" then
            local chairPosition
            if obj.PrimaryPart then
                chairPosition = obj.PrimaryPart.Position
            else
                local parts = {}
                for _, part in ipairs(obj:GetDescendants()) do
                    if part:IsA("BasePart") then
                        table.insert(parts, part)
                    end
                end
                if #parts > 0 then
                    local sum = Vector3.new(0, 0, 0)
                    for _, part in ipairs(parts) do
                        sum = sum + part.Position
                    end
                    chairPosition = sum / #parts
                end
            end
            
            if chairPosition then
                table.insert(beachChairPositions, chairPosition)
            end
        end
    end
end

local function isTrashFull()
    local goldenValue = lp:GetAttribute("GoldenTrash") or 0
    local trashValue = lp:GetAttribute("Trash") or 0
    return goldenValue >= 10 or trashValue >= 10 or (goldenValue + trashValue) >= 10
end

local function getClosestAvailableDumpster(char)
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    local dumpsters = ws:FindFirstChild("Map")
    if dumpsters then
        dumpsters = dumpsters:FindFirstChild("Environment")
        if dumpsters then
            dumpsters = dumpsters:FindFirstChild("Dumpsters")
        end
    end
    
    if not dumpsters then return nil end
    
    local closest, dist = nil, math.huge
    for _, v in ipairs(dumpsters:GetChildren()) do
        if v:IsA("BasePart") and v.Name:match("Dumpster_") then
            local timerGUI = v:FindFirstChild("TimerGUI")
            if timerGUI and not timerGUI.Enabled then
                local d = (root.Position - v.Position).Magnitude
                if d < dist then
                    dist = d
                    closest = v
                end
            end
        end
    end
    
    return closest
end

local function getChar()
    local char = lp.Character or lp.CharacterAdded:Wait()
    while not (char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid")) do
        task.wait(0.1)
        char = lp.Character
    end
    return char
end

local function isPaperNearBeachChair(paperPosition)
    for _, chairPos in ipairs(beachChairPositions) do
        local distance = (paperPosition - chairPos).Magnitude
        if distance <= 100 then
            return true
        end
    end
    return false
end

local paperCache = {}
local lastPaperUpdate = 0

local function updatePaperCache()
    local now = tick()
    if now - lastPaperUpdate < 2 then
        return
    end
    lastPaperUpdate = now
    
    paperCache = {}
    for _, v in ipairs(ws:GetDescendants()) do
        if v:IsA("Part") and v.Name == "Paper" and v.Transparency < 1 then
            table.insert(paperCache, v)
        end
    end
end

local function getClosestVisiblePaper(char)
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    updatePaperCache()
    
    local closest, dist = nil, math.huge
    for _, v in ipairs(paperCache) do
        if v.Parent and v.Transparency < 1 then
            local heightDifference = v.Position.Y - root.Position.Y
            if heightDifference <= 10 then
                if not isPaperNearBeachChair(v.Position) then
                    local d = (root.Position - v.Position).Magnitude
                    if d < dist then
                        dist = d
                        closest = v
                    end
                end
            end
        end
    end
    return closest
end

local function moveTo(char, target)
    if not farmEnabled then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not hum or not root or not target then return end
    
    while farmEnabled and target and target.Parent and (root.Position - target.Position).Magnitude > 10 do
        hum:MoveTo(target.Position)
        task.wait(0.1)
        hum = char:FindFirstChildOfClass("Humanoid")
        root = char:FindFirstChild("HumanoidRootPart")
        if not hum or not root then break end
    end
end

local function firePrompt(part)
    for _, v in ipairs(part:GetDescendants()) do
        if v:IsA("ProximityPrompt") then
            v:InputHoldBegin()
            task.wait()
            v:InputHoldEnd()
        end
    end
end

local function onPaperCollected(part)
    part.Transparency = 1
    part.CanCollide = false
    for _, v in ipairs(part:GetChildren()) do
        if v:IsA("ProximityPrompt") then
            v.Enabled = false
        end
    end
end

local function updateUI()
    if farmEnabled then
        toggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        toggleButton.Text = "â›” STOP FARM"
        statusLabel.Text = "ACTIVE"
        statusLabel.TextColor3 = Color3.fromRGB(80, 230, 100)
        statusDot.BackgroundColor3 = Color3.fromRGB(80, 230, 100)
        mainStroke.Color = Color3.fromRGB(80, 230, 100)
        
        task.spawn(function()
            while farmEnabled do
                TweenService:Create(statusDot, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut), {
                    BackgroundTransparency = 0.3
                }):Play()
                task.wait(0.5)
                if farmEnabled then
                    TweenService:Create(statusDot, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut), {
                        BackgroundTransparency = 0
                    }):Play()
                    task.wait(0.5)
                end
            end
        end)
    else
        toggleButton.BackgroundColor3 = Color3.fromRGB(40, 180, 70)
        toggleButton.Text = "âš¡ START FARM"
        statusLabel.Text = "INACTIVE"
        statusLabel.TextColor3 = Color3.fromRGB(120, 120, 130)
        statusDot.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        statusDot.BackgroundTransparency = 0
        mainStroke.Color = Color3.fromRGB(80, 80, 90)
    end
end

local function startFarm()
    farmThread = task.spawn(function()
        cacheBeachChairs()
        
        while farmEnabled do
            local char = getChar()
            
            enableNoclip()
            
            if isTrashFull() then
                local dumpster = getClosestAvailableDumpster(char)
                
                if dumpster then
                    moveTo(char, dumpster)
                    if farmEnabled then
                        task.wait(1)
                        firePrompt(dumpster)
                        task.wait(2)
                    end
                else
                    task.wait(3)
                end
            else
                local paper = getClosestVisiblePaper(char)
                if paper and farmEnabled then
                    moveTo(char, paper)
                    if farmEnabled then
                        task.wait(1)
                        firePrompt(paper)
                        onPaperCollected(paper)
                        task.wait(0.2)
                    end
                else
                    task.wait(1)
                end
            end
        end
        
        disableNoclip()
    end)
end

toggleButton.MouseButton1Click:Connect(function()
    farmEnabled = not farmEnabled
    updateUI()
    
    if farmEnabled then
        startFarm()
    else
        if farmThread then
            task.cancel(farmThread)
        end
        disableNoclip()
    end
end)

toggleButton.MouseEnter:Connect(function()
    TweenService:Create(toggleButton, TweenInfo.new(0.2), {
        Size = UDim2.new(1, -18, 0, 47)
    }):Play()
end)

toggleButton.MouseLeave:Connect(function()
    TweenService:Create(toggleButton, TweenInfo.new(0.2), {
        Size = UDim2.new(1, -20, 0, 45)
    }):Play()
end)

updateUI()
